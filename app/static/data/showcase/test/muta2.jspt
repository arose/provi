
load "1crn.pdb";

select all; cartoon on; wireframe 0.15;

selectionHalos OFF;


var x = "ATOM    201  N   TYR    39       1.622  13.211   6.524  1.00  5.01           N  
ATOM    202  CA  TYR    39       0.794  12.027   6.667  1.00  6.59           C  
ATOM    203  C   TYR    39       1.262  11.218   7.863  1.00  4.92           C  
ATOM    204  O   TYR    39       0.173  10.574   8.454  1.00  7.13           O  
ATOM    205  CB  TYR    39       0.804  11.240   5.360  1.00  9.66           C  
ATOM    206  CG  TYR    39      -0.197  10.133   5.366  1.00 11.56           C  
ATOM    207  CD1 TYR    39      -1.613  10.431   5.606  1.00 12.85           C  
ATOM    208  CD2 TYR    39       0.240   8.750   5.130  1.00 14.42           C  
ATOM    209  CE1 TYR    39      -2.594   9.338   5.648  1.00 16.61           C  
ATOM    210  CE2 TYR    39      -0.744   7.658   5.152  1.00 17.11           C  
ATOM    211  CZ  TYR    39      -2.154   7.958   5.422  1.00 19.97           C  
ATOM    212  OH  TYR    39      -3.069   6.942   5.457  1.00 28.96           O  ";


var x2 = "ATOM     21  N   CNO     4       5.629   1.648  -0.119  1.00  0.00           N  
ATOM     22  CA  CNO     4       6.336   2.900  -0.377  1.00  0.00           C  
ATOM     23  C   CNO     4       7.822   2.736  -0.162  1.00  0.00           C  
ATOM     24  O   CNO     4       8.282   2.144   0.824  1.00  0.00           O  
ATOM     25  CB  CNO     4       5.729   3.998   0.519  1.00  0.00           C  
ATOM     26  SG  CNO     4       6.509   5.594   0.190  1.00  0.00           S  
ATOM     27  H   CNO     4       5.820   0.950   0.682  1.00  0.00           H  
ATOM     28  HA  CNO     4       6.185   3.172  -1.437  1.00  0.00           H  
ATOM     29  H29 CNO     4       5.838   3.751   1.594  1.00  0.00           H  
ATOM     30  H30 CNO     4       4.645   4.107   0.339  1.00  0.00           H  
HETATM    1  ON  CNO     4       0.443   4.359   0.621  1.00  0.00           O  
HETATM    2  N2  CNO     4       1.138   5.499   0.870  1.00  0.00           N  
HETATM    3  C3  CNO     4       1.815   6.056  -0.322  1.00  0.00           C  
HETATM    4  C4  CNO     4       2.125   5.369   1.972  1.00  0.00           C  
HETATM    5  C5  CNO     4       2.984   6.859   0.258  1.00  0.00           C  
HETATM    6  C6  CNO     4       3.393   6.081   1.488  1.00  0.00           C  
HETATM    7  C7  CNO     4       1.541   6.077   3.201  1.00  0.00           C  
HETATM    8  C8  CNO     4       0.853   6.993  -1.059  1.00  0.00           C  
HETATM    9  C9  CNO     4       2.284   4.941  -1.275  1.00  0.00           C  
HETATM   10  C10 CNO     4       2.484   3.909   2.327  1.00  0.00           C  
HETATM   15  H15 CNO     4       0.605   5.572   3.527  1.00  0.00           H  
HETATM   16  H16 CNO     4       1.304   7.133   2.964  1.00  0.00           H  
HETATM   17  H17 CNO     4       2.263   6.058   4.047  1.00  0.00           H  
HETATM   18  H18 CNO     4       1.354   7.471  -1.930  1.00  0.00           H  
HETATM   19  H19 CNO     4       0.500   7.799  -0.375  1.00  0.00           H  
HETATM   20  H20 CNO     4      -0.031   6.435  -1.423  1.00  0.00           H  
HETATM   21  H21 CNO     4       2.796   5.384  -2.157  1.00  0.00           H  
HETATM   22  H22 CNO     4       1.419   4.363  -1.665  1.00  0.00           H  
HETATM   23  H23 CNO     4       2.949   4.238  -0.742  1.00  0.00           H  
HETATM   24  H24 CNO     4       1.591   3.353   2.679  1.00  0.00           H  
HETATM   25  H25 CNO     4       2.906   3.379   1.450  1.00  0.00           H  
HETATM   26  H26 CNO     4       3.247   3.888   3.142  1.00  0.00           H  
HETATM   28  H28 CNO     4       4.105   6.497   2.232  1.00  0.00           H  
HETATM   29  CE  CNO     4       4.110   7.437  -0.654  1.00  0.00           C  
HETATM   30  H30 CNO     4       3.730   8.188  -1.375  1.00  0.00           H  
HETATM   31  SD  CNO     4       5.175   6.156  -1.423  1.00  0.00           S  
HETATM   32  H32 CNO     4       4.796   7.981   0.026  1.00  0.00           H  ";

var x3 = "ATOM     21  N  aCNO     4       5.629   1.648  -0.119  1.00  0.00           N  
ATOM     22  CA aCNO     4       6.336   2.900  -0.377  1.00  0.00           C  
ATOM     23  C  aCNO     4       7.822   2.736  -0.162  1.00  0.00           C  
ATOM     24  O  aCNO     4       8.282   2.144   0.824  1.00  0.00           O  
ATOM     25  CB aCNO     4       5.729   3.998   0.519  1.00  0.00           C  
ATOM     26  SG aCNO     4       4.005   4.305   0.074  1.00  0.00           S  
ATOM     27  H  aCNO     4       5.820   0.950   0.682  1.00  0.00           H  
ATOM     28  HA aCNO     4       6.185   3.172  -1.437  1.00  0.00           H  
ATOM     29  H29aCNO     4       6.301   4.945   0.445  1.00  0.00           H  
ATOM     30  H30aCNO     4       5.757   3.706   1.584  1.00  0.00           H  
HETATM    1  ON aCNO     4       4.482  10.488   1.527  1.00  0.00           O  
HETATM    2  N2 aCNO     4       5.024   9.243   1.491  1.00  0.00           N  
HETATM    3  C3 aCNO     4       5.602   8.884   0.177  1.00  0.00           C  
HETATM    4  C4 aCNO     4       4.092   8.171   1.921  1.00  0.00           C  
HETATM    5  C5 aCNO     4       5.539   7.352   0.151  1.00  0.00           C  
HETATM    6  C6 aCNO     4       4.285   7.021   0.926  1.00  0.00           C  
HETATM    7  C7 aCNO     4       4.503   7.741   3.334  1.00  0.00           C  
HETATM    8  C8 aCNO     4       7.061   9.347   0.120  1.00  0.00           C  
HETATM    9  C9 aCNO     4       4.810   9.521  -0.979  1.00  0.00           C  
HETATM   10  C10aCNO     4       2.605   8.588   1.909  1.00  0.00           C  
HETATM   15  H15aCNO     4       4.389   8.589   4.043  1.00  0.00           H  
HETATM   16  H16aCNO     4       5.562   7.413   3.348  1.00  0.00           H  
HETATM   17  H17aCNO     4       3.869   6.898   3.689  1.00  0.00           H  
HETATM   18  H18aCNO     4       7.538   9.040  -0.838  1.00  0.00           H  
HETATM   19  H19aCNO     4       7.641   8.898   0.958  1.00  0.00           H  
HETATM   20  H20aCNO     4       7.122  10.449   0.206  1.00  0.00           H  
HETATM   21  H21aCNO     4       5.257   9.230  -1.955  1.00  0.00           H  
HETATM   22  H22aCNO     4       4.855  10.631  -0.927  1.00  0.00           H  
HETATM   23  H23aCNO     4       3.747   9.223  -0.926  1.00  0.00           H  
HETATM   24  H24aCNO     4       2.420   9.424   2.615  1.00  0.00           H  
HETATM   25  H25aCNO     4       2.289   8.905   0.895  1.00  0.00           H  
HETATM   26  H26aCNO     4       1.962   7.729   2.217  1.00  0.00           H  
HETATM   28  H28aCNO     4       4.049   5.981   1.239  1.00  0.00           H  
HETATM   29  CE aCNO     4       5.836   6.544  -1.150  1.00  0.00           C  
HETATM   30  H30aCNO     4       6.252   7.178  -1.959  1.00  0.00           H  
HETATM   31  SD aCNO     4       4.447   5.477  -1.695  1.00  0.00           S  
HETATM   32  H32aCNO     4       6.635   5.825  -0.879  1.00  0.00           H

ATOM     21  N  bCNO     4       5.629   1.648  -0.119  1.00  0.00           N  
ATOM     22  CA bCNO     4       6.336   2.900  -0.377  1.00  0.00           C  
ATOM     23  C  bCNO     4       7.822   2.736  -0.162  1.00  0.00           C  
ATOM     24  O  bCNO     4       8.282   2.144   0.824  1.00  0.00           O  
ATOM     25  CB bCNO     4       5.729   3.998   0.519  1.00  0.00           C  
ATOM     26  SG bCNO     4       4.005   4.305   0.074  1.00  0.00           S  
ATOM     27  H  bCNO     4       5.820   0.950   0.682  1.00  0.00           H  
ATOM     28  HA bCNO     4       6.185   3.172  -1.437  1.00  0.00           H  
ATOM     29  H29bCNO     4       6.301   4.945   0.445  1.00  0.00           H  
ATOM     30  H30bCNO     4       5.757   3.706   1.584  1.00  0.00           H  
HETATM    1  ON bCNO     4       8.622   7.674  -4.232  1.00  0.00           O  
HETATM    2  N2 bCNO     4       7.378   7.231  -4.549  1.00  0.00           N  
HETATM    3  C3 bCNO     4       6.521   6.971  -3.372  1.00  0.00           C  
HETATM    4  C4 bCNO     4       7.375   6.033  -5.426  1.00  0.00           C  
HETATM    5  C5 bCNO     4       5.513   5.929  -3.870  1.00  0.00           C  
HETATM    6  C6 bCNO     4       6.298   5.099  -4.860  1.00  0.00           C  
HETATM    7  C7 bCNO     4       7.001   6.496  -6.839  1.00  0.00           C  
HETATM    8  C8 bCNO     4       5.789   8.259  -2.983  1.00  0.00           C  
HETATM    9  C9 bCNO     4       7.346   6.462  -2.176  1.00  0.00           C  
HETATM   10  C10bCNO     4       8.718   5.273  -5.459  1.00  0.00           C  
HETATM   15  H15bCNO     4       7.771   7.196  -7.231  1.00  0.00           H  
HETATM   16  H16bCNO     4       6.024   7.020  -6.831  1.00  0.00           H  
HETATM   17  H17bCNO     4       6.931   5.629  -7.532  1.00  0.00           H  
HETATM   18  H18bCNO     4       5.093   8.080  -2.132  1.00  0.00           H  
HETATM   19  H19bCNO     4       5.195   8.641  -3.845  1.00  0.00           H  
HETATM   20  H20bCNO     4       6.513   9.043  -2.685  1.00  0.00           H  
HETATM   21  H21bCNO     4       6.680   6.266  -1.307  1.00  0.00           H  
HETATM   22  H22bCNO     4       8.081   7.228  -1.847  1.00  0.00           H  
HETATM   23  H23bCNO     4       7.908   5.553  -2.457  1.00  0.00           H  
HETATM   24  H24bCNO     4       9.530   5.915  -5.860  1.00  0.00           H  
HETATM   25  H25bCNO     4       9.007   4.931  -4.445  1.00  0.00           H  
HETATM   26  H26bCNO     4       8.636   4.373  -6.114  1.00  0.00           H  
HETATM   28  H28bCNO     4       5.802   4.365  -5.530  1.00  0.00           H  
HETATM   29  CE bCNO     4       4.551   5.189  -2.890  1.00  0.00           C  
HETATM   30  H30bCNO     4       3.569   4.957  -3.351  1.00  0.00           H  
HETATM   31  SD bCNO     4       4.418   5.979  -1.240  1.00  0.00           S  
HETATM   32  H32bCNO     4       5.032   4.212  -2.680  1.00  0.00           H  

ATOM     21  N  cCNO     4       5.629   1.648  -0.119  1.00  0.00           N  
ATOM     22  CA cCNO     4       6.336   2.900  -0.377  1.00  0.00           C  
ATOM     23  C  cCNO     4       7.822   2.736  -0.162  1.00  0.00           C  
ATOM     24  O  cCNO     4       8.282   2.144   0.824  1.00  0.00           O  
ATOM     25  CB cCNO     4       5.729   3.998   0.519  1.00  0.00           C  
ATOM     26  SG cCNO     4       6.509   5.594   0.190  1.00  0.00           S  
ATOM     27  H  cCNO     4       5.820   0.950   0.682  1.00  0.00           H  
ATOM     28  HA cCNO     4       6.185   3.172  -1.437  1.00  0.00           H  
ATOM     29  H29cCNO     4       5.838   3.751   1.594  1.00  0.00           H  
ATOM     30  H30cCNO     4       4.645   4.107   0.339  1.00  0.00           H  
HETATM    1  ON cCNO     4       6.054   4.708  -7.719  1.00  0.00           O  
HETATM    2  N2 cCNO     4       5.611   4.571  -6.443  1.00  0.00           N  
HETATM    3  C3 cCNO     4       5.954   5.714  -5.568  1.00  0.00           C  
HETATM    4  C4 cCNO     4       6.048   3.311  -5.789  1.00  0.00           C  
HETATM    5  C5 cCNO     4       5.971   5.110  -4.159  1.00  0.00           C  
HETATM    6  C6 cCNO     4       6.472   3.699  -4.368  1.00  0.00           C  
HETATM    7  C7 cCNO     4       4.841   2.366  -5.756  1.00  0.00           C  
HETATM    8  C8 cCNO     4       4.854   6.776  -5.667  1.00  0.00           C  
HETATM    9  C9 cCNO     4       7.309   6.333  -5.956  1.00  0.00           C  
HETATM   10  C10cCNO     4       7.239   2.620  -6.487  1.00  0.00           C  
HETATM   15  H15cCNO     4       4.521   2.114  -6.790  1.00  0.00           H  
HETATM   16  H16cCNO     4       3.988   2.843  -5.233  1.00  0.00           H  
HETATM   17  H17cCNO     4       5.095   1.421  -5.227  1.00  0.00           H  
HETATM   18  H18cCNO     4       5.058   7.625  -4.976  1.00  0.00           H  
HETATM   19  H19cCNO     4       3.867   6.335  -5.396  1.00  0.00           H  
HETATM   20  H20cCNO     4       4.787   7.171  -6.699  1.00  0.00           H  
HETATM   21  H21cCNO     4       7.548   7.183  -5.280  1.00  0.00           H  
HETATM   22  H22cCNO     4       7.275   6.746  -6.987  1.00  0.00           H  
HETATM   23  H23cCNO     4       8.103   5.566  -5.924  1.00  0.00           H  
HETATM   24  H24cCNO     4       6.977   2.325  -7.524  1.00  0.00           H  
HETATM   25  H25cCNO     4       8.122   3.289  -6.524  1.00  0.00           H  
HETATM   26  H26cCNO     4       7.529   1.697  -5.930  1.00  0.00           H  
HETATM   28  H28cCNO     4       6.432   2.939  -3.558  1.00  0.00           H  
HETATM   29  CE cCNO     4       6.513   5.909  -2.934  1.00  0.00           C  
HETATM   30  H30cCNO     4       7.516   5.565  -2.612  1.00  0.00           H  
HETATM   31  SD cCNO     4       5.312   6.062  -1.555  1.00  0.00           S  
HETATM   32  H32cCNO     4       6.643   6.951  -3.292  1.00  0.00           H  

ATOM     21  N  dCNO     4       5.629   1.648  -0.119  1.00  0.00           N  
ATOM     22  CA dCNO     4       6.336   2.900  -0.377  1.00  0.00           C  
ATOM     23  C  dCNO     4       7.822   2.736  -0.162  1.00  0.00           C  
ATOM     24  O  dCNO     4       8.282   2.144   0.824  1.00  0.00           O  
ATOM     25  CB dCNO     4       5.729   3.998   0.519  1.00  0.00           C  
ATOM     26  SG dCNO     4       6.509   5.594   0.190  1.00  0.00           S  
ATOM     27  H  dCNO     4       5.820   0.950   0.682  1.00  0.00           H  
ATOM     28  HA dCNO     4       6.185   3.172  -1.437  1.00  0.00           H  
ATOM     29  H29dCNO     4       5.838   3.751   1.594  1.00  0.00           H  
ATOM     30  H30dCNO     4       4.645   4.107   0.339  1.00  0.00           H  
HETATM    1  ON dCNO     4       0.443   4.359   0.621  1.00  0.00           O  
HETATM    2  N2 dCNO     4       1.138   5.499   0.870  1.00  0.00           N  
HETATM    3  C3 dCNO     4       1.815   6.056  -0.322  1.00  0.00           C  
HETATM    4  C4 dCNO     4       2.125   5.369   1.972  1.00  0.00           C  
HETATM    5  C5 dCNO     4       2.984   6.859   0.258  1.00  0.00           C  
HETATM    6  C6 dCNO     4       3.393   6.081   1.488  1.00  0.00           C  
HETATM    7  C7 dCNO     4       1.541   6.077   3.201  1.00  0.00           C  
HETATM    8  C8 dCNO     4       0.853   6.993  -1.059  1.00  0.00           C  
HETATM    9  C9 dCNO     4       2.284   4.941  -1.275  1.00  0.00           C  
HETATM   10  C10dCNO     4       2.484   3.909   2.327  1.00  0.00           C  
HETATM   15  H15dCNO     4       0.605   5.572   3.527  1.00  0.00           H  
HETATM   16  H16dCNO     4       1.304   7.133   2.964  1.00  0.00           H  
HETATM   17  H17dCNO     4       2.263   6.058   4.047  1.00  0.00           H  
HETATM   18  H18dCNO     4       1.354   7.471  -1.930  1.00  0.00           H  
HETATM   19  H19dCNO     4       0.500   7.799  -0.375  1.00  0.00           H  
HETATM   20  H20dCNO     4      -0.031   6.435  -1.423  1.00  0.00           H  
HETATM   21  H21dCNO     4       2.796   5.384  -2.157  1.00  0.00           H  
HETATM   22  H22dCNO     4       1.419   4.363  -1.665  1.00  0.00           H  
HETATM   23  H23dCNO     4       2.949   4.238  -0.742  1.00  0.00           H  
HETATM   24  H24dCNO     4       1.591   3.353   2.679  1.00  0.00           H  
HETATM   25  H25dCNO     4       2.906   3.379   1.450  1.00  0.00           H  
HETATM   26  H26dCNO     4       3.247   3.888   3.142  1.00  0.00           H  
HETATM   28  H28dCNO     4       4.105   6.497   2.232  1.00  0.00           H  
HETATM   29  CE dCNO     4       4.110   7.437  -0.654  1.00  0.00           C  
HETATM   30  H30dCNO     4       3.730   8.188  -1.375  1.00  0.00           H  
HETATM   31  SD dCNO     4       5.175   6.156  -1.423  1.00  0.00           S  
HETATM   32  H32dCNO     4       4.796   7.981   0.026  1.00  0.00           H  ";


function mutate( sele, aa ){
    
    var resno = {@sele}.resno;
    
    var aa_split = aa.split("\n");
    var n = aa_split.length;
    var m = abs(resno.length);
    for( var i=1; i<=n; ++i){
        for( var j=0; j<m; ++j ){
            aa_split[i][26-j] = resno[m-j];
        }
        print aa_split[i];
    }
    aa = aa_split.join("\n");
    
    var n = {*}.atomIndex.max;
    
    set appendNew OFF;
    load append '@aa';
    set appendNew ON;

    var old = {atomIndex <= n and @sele};
    var new = {atomIndex > n};

    var t = {@old and *.CA}.XYZ - {@new and *.CA}.XYZ;
    
    select @new;
    translateSelected @t;

    var v1 = {@old and *.CB}.XYZ - {@old and *.CA}.XYZ;
    var ca = {@old and *.CA}.XYZ;
    var v2 = {@new and *.CB}.XYZ - {@new and *.CA}.XYZ;
    var cr = cross(v1, v2);
    var p = cr + ca;
    
    if(draw){
        draw ID "p" @p;
        draw ID "v2" vector {@new and *.CA} @v1 scale 500;
        draw ID "v1" vector {@new and *.CA} @v2 scale 500;
        draw ID "cr" vector {@new and *.CA} @cr scale 500;
    }
    
    var an = -angle({@old and *.CB}, {@old and *.CA}, {@new and *.CB});
    
    select @new;
    rotateSelected @an @ca @p;

    {@new and (*.N)}.XYZ = {@old and (*.N)}.XYZ;
    {@new and (*.C)}.XYZ = {@old and (*.C)}.XYZ;
    {@new and (*.O)}.XYZ = {@old and (*.O)}.XYZ;

    connect (@new and *.N) (within(1.4, (@old and *.N)) and not @old and not @new);
    connect (@new and *.C) (within(1.4, (@old and *.C)) and not @old and not @new);

    delete {@old};
    #connect;

    #delete {@old and sidechain};
    #delete {@new and backbone};
    return new;
}


var new = mutate( {36}, x3 );

center {@new};

select all; cartoon on; wireframe 0.15;
select none;

select {36};
selectionHalos ON;

